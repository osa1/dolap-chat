<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">

  <script src="js/jquery-1.7.1.min.js"></script>
  <script src="js/jquery.terminal-0.4.11.js"></script>
  <script src="js/jquery.mousewheel.min.js"></script>
  <link href="css/jquery.terminal.css" rel="stylesheet"/>
  <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet"/>
  <link href="bootstrap/css/bootstrap.css" rel="stylesheet"/>
  <script src="bootstrap/js/bootstrap.js"></script>
  <script src="bootstrap-plugins/bootstrap-modal.js"></script>
  <link href="css/custom.css" rel="stylesheet"/>
</head>
<body id="terminals">

  <div id="overlays">
    <div id="info"></div>
  </div>


  <div class="modal hide fade" id="loginModal">
    <div class="modal-header">
      <a class="close" data-dismiss="modal">Ã—</a>
      <h3>Login</h3>
    </div>
    <div class="modal-body">
      <form class="well">
        <input type="text" class="span3" placeholder="Nick" id="nick-input">
        <input type="password" class="span3" placeholder="Password">
        <p id="login-text"></p>
        <a class="btn btn-primary" id="loginBtn">Submit</a>
        <!-- <button type="submit" class="btn btn-primary" id="loginBtn">Submit</button> -->
      </form>
    </div>
  </div>

</body>

<script type="text/javascript">
var socket = new WebSocket("ws://0.0.0.0:3000/");

function send (msg) {
  // for debugging purposes
  console.log("SENT MSG: " + msg);
  socket.send(msg);
}

socket.onopen = function () {

};

socket.onmessage = function (evt) {
  var msg = evt.data;
  console.log('GOT MSG: ' + msg);
  var p1 = first_param(msg);
  var cmd = p1.first.toLowerCase();
  if (cmd === 'join') {
    // join nick chan
    var join_params = get_params(p1.rest, 2).params;
    var chan_data = $("#" + join_params[1]).data('channel');
    $("#" + join_params[1]).terminal().echo(join_params[0] + " has joined the channel.");
    chan_data.add_user(join_params[1]);
    if (join_params[1] === current_terminal) {
      chan_data.users.push(join_params[0]);
      update_user_info_div(chan_data.users);
    }
  } else if (cmd === 'leave') {
    // leave nick chan
    var leave_params = get_params(p1.rest, 2).params;
    $("#" + leave_params[1]).terminal().echo(leave_params[0] + " has left the channel.");
    $("#" + leave_params[1]).data('channel').remove_user(join_params[1]);
  } else if (cmd === 'disconnect') {
    // disconnect nick
    var disconnect_params = get_params(p1.rest, 1).params;
    for (var i = 0; i < terminals.length; i++) {
      $("#" + terminals[i]).data('channel').remove_user(disconnect_params[0]);
      $("#" + terminals[i]).terminal().echo(diconnect_params[0] + " has disconnected.");
    }
  } else if (cmd === 'msg') {
    // msg nick chan [msg]
    var msg_param_parts = get_params(p1.rest, 2);
    var msg_params = msg_param_parts.params;
    var msg = msg_param_parts.rest;
    $("#" + msg_params[1]).terminal().echo(msg_params[0] + "> " + msg);
  } else if (cmd === 'users') {
    var parts = get_params(p1.rest, 1);
    var chan = parts.params[0];
    var users = parts.rest.split(",");
    var chan_data = $("#" + chan).data('channel');

    chan_data.users = users;
    if (current_terminal === chan) {
      // chan_data.users.push(nick);
      update_user_info_div(chan_data.users);
    }
  }
};

socket.onclose = function (e) {
  console.log("close: " + e.code + " " + e.reason);
};

socket.onerror = function (e) {
  console.log("error: " + e.code);
};

// utils ---------------------------------

function first_param (text) {
  var t = jQuery.trim(text);
  var split = t.indexOf(" ");
  var first, rest;
  if (split === -1) {
    first = text;
  } else {
    first = t.slice(0, split);
    rest = t.slice(split+1);
  }
  return {'first': first,
          'rest': rest};
}

function get_params (text, n) {
  var params = [];
  var rest = text;
  for (var i = 0; i < n; i++) {
    var parts = first_param(rest);
    params.push(parts.first);
    rest = parts.rest;
  }
  return {'params': params,
          'rest': rest};
}

// --------------------------------------


var terminals = [];
var nick;
var current_terminal;

function add_terminal (name) {
  $("#terminals").append('<div id="' + name + '"></div>');
  jQuery(function ($, undefined) {
    $('#' + name).terminal(function (command, term) {

      if (command[0] === "/") {
        send(command.slice(1));
      } else {
        send("msg " + name + " " + command);
      }
    },
    { greetings: 'Channel: ' + name,
      name: name,
      prompt: nick + '> '});
  });

  var tab_name = name + "_tab";
  $("#tabs").append('<li id="' + tab_name + '"><a>' + name + '</a></li>');
  $("#" + tab_name).click(function () {
    switch_terminal(name);
  });

  $("#" + name).data('channel', new Channel(name));

  terminals.push(name);
}

function Channel (name) {
  this.name = name
  this.users = [];

  this.add_user = function (nick) {
    this.users.push(nick);
    if (this.name === current_terminal)
      update_user_info_div(this.users);
  };

  this.remove_user = function (nick) {
    this.users.splice(users.indexOf(nick), 1);
    if (this.name === current_terminal)
      update_user_info_div(this.users);
  };
}

function close_terminal (name) {
  $("#" + name).remove();
  $("#" + name + "_tab").remove();

  terminals.splice(terminals.indexOf(name), 1); // wth
  switch_terminal(terminals[0]);
}

function switch_terminal (name) {
  for (idx in terminals) {
    $("#" + terminals[idx]).hide();
    $("#" + terminals[idx] + "_tab").removeAttr("class");
  }
  $("#" + name).show();
  $("#" + name + "_tab").attr("class", "active");
  scroll_bottom(name);

  current_terminal = name;
}

function scroll_bottom (terminal_name) {
  var t = $("#" + terminal_name).terminal();
  t.scroll(t.height());
}

function update_user_info_div (users) {
  $("#info").html("");

  for (var i=0; i < users.length; i++) {
    if (i !== 0) {
      $("#info").append("<br>");
    }
    $("#info").append(users[i]);
  }
}

$(document).ready(function () {
  $("#loginModal").modal('show');
  $("#loginBtn").click(function () {
    $("#login-text").html("Logging in..");
    send("login " + $("#nick-input").val());
    nick = $("#nick-input").val();

    setTimeout(function () {
      send("join oda");
    }, 2000);

    $("#login-text").html("");
    $("#loginModal").modal('hide');
    add_terminal('oda');
    switch_terminal('oda');
    $("#tabs").append('');
  });
});

</script>

</html>