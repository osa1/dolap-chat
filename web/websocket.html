<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">

  <script src="js/jquery-1.7.1.min.js"></script>
  <script src="js/jquery.terminal-0.4.11.js"></script>
  <script src="js/jquery.mousewheel.min.js"></script>
  <link href="css/jquery.terminal.css" rel="stylesheet"/>
  <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet"/>
  <link href="bootstrap/css/bootstrap.css" rel="stylesheet"/>
  <script src="bootstrap/js/bootstrap.js"></script>
  <link href="css/custom.css" rel="stylesheet"/>
</head>
<body id="terminals">

  <ul class="nav nav-tabs" id="tabs">
  </ul>

  <div id="overlays">
    <div id="info"></div>
  </div>

</body>

<script type="text/javascript">
var input_div = $("#input");
var socket = new WebSocket("ws://0.0.0.0:3000/");

socket.onopen = function() {
  // socket.send("");
  input_div.append("<p>connection established.</p>");
};
socket.onmessage = function (evt) {
  var msg = evt.data;
  // console.log(msg);
  input_div.append("<p>" + msg + "</p>");
};
socket.onclose = function() {
  // console.log("connection is closed");
  input_div.append("<p>connection is closed</p>");
};

socket.onerror = function () {
  input_div.append("<p>error</p>");
}

var send_btn = $("#send-btn");
var textfield = $("#textfield");

textfield.keydown(function (event) {
  if (event.which == 13 && event.shiftKey) {
    send();
  }
});

send_btn.click(send);

function send() {
  socket.send(textfield.val());
  textfield.val("");
}


// utils ---------------------------------

function first_param (text) {
  var t = jQuery.trim(text);
  var split = t.indexOf(" ");
  var first, rest;
  if (split === -1) {
    first = text;
  } else {
    first = t.slice(0, split);
    rest = t.slice(split+1);
  }
  return {'first': first,
          'rest': rest};
}

function get_params (text, n) {
  var params = [];
  var rest = text;
  for (var i = 0; i < n; i++) {
    var parts = first_param(rest);
    params.push(parts.first);
    rest = parts.rest;
  }
  return {'params': params,
          'rest': rest};
}

</script>

<script type="text/javascript">

var terminals = [];
var nick = "osa1";
var current_terminal;
var users = [];

function add_terminal (name) {
  $("#terminals").append('<div id="' + name + '"></div>');
  jQuery(function ($, undefined) {
    $('#' + name).terminal(function (command, term) {
      if (command !== '') {
        var result = window.eval("(" + command + ")");
        if (result !== undefined) {
          term.echo(String(result));
        }
      } else {
        term.echo('');
      }
    },
    { greetings: 'Channel: ' + name,
      name: name,
      prompt: nick + '> '});
  });

  var tab_name = name + "_tab";
  $("#tabs").append('<li id="' + tab_name + '"><a>' + name + '</a></li>');
  $("#" + tab_name).click(function () {
    console.log("switched to terminal " + name);
    switch_terminal(name);
  });

  $("#" + name).data('channel', new Channel(name));

  terminals.push(name);
}

function Channel (name) {
  this.name = name
  this.users = [];

  this.add_user = function (nick) {
    this.users.push(nick);
    if (this.name === current_terminal)
      update_user_info_div(this.users);
  };

  this.remove_user = function (nick) {
    this.users.splice(users.indexOf(nick), 1);
    if (this.name === current_terminal)
      update_user_info_div();
  };
}

function close_terminal (name) {
  $("#" + name).remove();
  $("#" + name + "_tab").remove();

  terminals.splice(terminals.indexOf(name), 1); // wth
  switch_terminal(terminals[0]);
}

function switch_terminal (name) {
  for (idx in terminals) {
    $("#" + terminals[idx]).hide();
    $("#" + terminals[idx] + "_tab").removeAttr("class");
  }
  $("#" + name).show();
  $("#" + name + "_tab").attr("class", "active");
  scroll_bottom(name);

  current_terminal = name;
}

function scroll_bottom (terminal_name) {
  var t = $("#" + terminal_name).terminal();
  t.scroll(t.height());
}

function update_user_info_div (users) {
  $("#info").html("");

  for (var i=0; i < users.length; i++) {
    if (i !== 0) {
      $("#info").append("<br>");
      console.log("br");
    }
    $("#info").append(users[i]);
  }
}

add_terminal('dt');
// switch_terminal('dt');
// because of a bug when running switch_terminal('dt'):
  $("#dt_tab").attr("class", "active");
  current_terminal = "dt";
  $("#dt").data('channel').add_user(nick);

</script>

</html>