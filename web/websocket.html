<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">

  <script src="js/jquery-1.7.1.min.js"></script>
  <script src="js/jquery.terminal-0.4.11.js"></script>
  <script src="js/jquery.mousewheel.min.js"></script>
  <link href="css/jquery.terminal.css" rel="stylesheet"/>
  <link href="bootstrap/css/bootstrap-responsive.css" rel="stylesheet"/>
  <link href="bootstrap/css/bootstrap.css" rel="stylesheet"/>
  <script src="bootstrap/js/bootstrap.js"></script>
  <script src="bootstrap-plugins/bootstrap-modal.js"></script>
  <link href="css/custom.css" rel="stylesheet"/>
</head>
<body id="terminals">
 <ul class="nav nav-tabs" id="tabs">
 </ul>

  <div id="overlays">
    <div id="info" style="top: 100px; left: 700px"></div>
  </div>


  <div class="modal hide fade" id="loginModal">
    <div class="modal-header">
      <a class="close" data-dismiss="modal">Ã—</a>
      <h3>Login</h3>
    </div>
    <div class="modal-body">
      <form class="well">
        <input type="text" class="span3" placeholder="Nick" id="nick-input">
        <input type="password" class="span3" placeholder="Password">
        <p id="login-text"></p>
        <a class="btn btn-primary" id="loginBtn">Submit</a>
        <!-- <button type="submit" class="btn btn-primary" id="loginBtn">Submit</button> -->
      </form>
    </div>
  </div>

</body>

<script type="text/javascript">
var socket = new WebSocket("ws://0.0.0.0:3000/");

function send (msg) {
  // for debugging purposes
  console.log("SENT MSG: " + msg);
  socket.send(msg);
}

socket.onopen = function () {

};

socket.onmessage = function (evt) {
  var msg = evt.data;
  console.log('GOT MSG: ' + msg);
  handle_msg(msg);
  // $("#oda").terminal().echo(msg);
};

socket.onclose = function (e) {
  console.log("close: " + e.code + " " + e.reason);
};

socket.onerror = function (e) {
  console.log("error: " + e.code);
  $("#oda").terminal().error("error: " + e.code)
};

// parser ---------------------------------

function Parser (text) {
    this.rest = jQuery.trim(text);

    this.getNextToken = function () {
        var space_idx = this.rest.indexOf(' ');
        if (space_idx == -1) {
            var r = this.rest;
            this.rest = "";
            return r;
        }
        var r = this.rest.slice(0, space_idx);
        this.rest = jQuery.trim(this.rest.slice(space_idx+1));
        return r;
    }

    this.getRest = function () {
        return this.rest;
    }
}

// command handling ---------------------------

function handle_msg (msg) {
  var parser = new Parser(msg);
  var cmd = parser.getNextToken();
  if (cmd === 'msg') {
    var from = parser.getNextToken();
    var chan = parser.getNextToken();
    var m = parser.getRest();
    if (from !== nick)
      $("#" + chan).terminal().echo(from + "> " + m);
  } else if (cmd === 'join') {
    var user = parser.getNextToken();
    var chan = parser.getNextToken();
    $("#" + chan).data('channel').add_user(user);
    $("#" + chan).terminal().echo(user + " has joined the channel.");
  } else if (cmd === 'leave') {
    var user = parser.getNextToken();
    var chan = parser.getNextToken();
    $("#" + chan).data('channel').remove_user(user);
    $("#" + chan).terminal().echo(user + " has left the channel.");
  } else if (cmd === 'users') {
    var chan = parser.getNextToken();
    var users = parser.getRest().split(',');
    for (var i = 0; i < users.length; i++) {
      $("#" + chan).data('channel').add_user(users[i]);
    }
  } else {
    for (var i = 0; i < terminals.length; i++) {
      $("#" + terminals[i]).terminal().error('SERVER: ' + msg);
    }
  }
}

// --------------------------------------


var terminals = [];
var nick;
var current_terminal;

function add_terminal (name) {
  $("#terminals").append('<div id="' + name + '"></div>');
  jQuery(function ($, undefined) {
    $('#' + name).terminal(function (command, term) {
      if (command[0] === "/") {
        send(command.slice(1));
      } else {
        send("msg " + name + " " + command);
      }
    },
    { greetings: 'Channel: ' + name,
      name: name,
      prompt: nick + '> '});
  });

  var tab_name = name + "_tab";
  $("#tabs").append('<li id="' + tab_name + '"><a>' + name + '</a></li>');
  $("#" + tab_name).click(function () {
    switch_terminal(name);
  });

  $("#" + name).data('channel', new Channel(name));

  terminals.push(name);
}

function Channel (name) {
  this.name = name
  this.users = [];

  this.add_user = function (nick) {
    this.users.push(nick);
    if (this.name === current_terminal)
      update_user_info_div(this.users);
  };

  this.remove_user = function (nick) {
    this.users.splice(this.users.indexOf(nick), 1);
    if (this.name === current_terminal)
      update_user_info_div(this.users);
  };
}

function close_terminal (name) {
  $("#" + name).remove();
  $("#" + name + "_tab").remove();

  terminals.splice(terminals.indexOf(name), 1); // wth
  switch_terminal(terminals[0]);
}

function switch_terminal (name) {
  for (idx in terminals) {
    $("#" + terminals[idx]).hide();
    $("#" + terminals[idx] + "_tab").removeAttr("class");
  }
  $("#" + name).show();
  $("#" + name + "_tab").attr("class", "active");
  scroll_bottom(name);

  current_terminal = name;
  update_user_info_div($("#" + name).data('channel').users);
}

function scroll_bottom (terminal_name) {
  var t = $("#" + terminal_name).terminal();
  t.scroll(t.height());
}

function update_user_info_div (users) {
  $("#info").html("");
  $("#info").append("<h2>Users</h2>");

  for (var i=0; i < users.length; i++) {
    if (i !== 0) {
      $("#info").append("<br>");
    }
    $("#info").append(users[i]);
  }
}

$(document).ready(function () {
  $("#loginModal").modal('show');
  $("#loginBtn").click(function () {
    $("#login-text").html("Logging in..");
    send("login " + $("#nick-input").val());
    nick = $("#nick-input").val();

    setTimeout(function () {
      send("join oda");
    }, 2000);

    $("#login-text").html("");
    $("#loginModal").modal('hide');
    add_terminal('oda');
    switch_terminal('oda');
    $("#tabs").append('');
  });

    // nick = "osa1";

    // add_terminal('oda');
    // current_terminal = 'oda';
    // // switch_terminal('oda');
    // $("#tabs").append('');


  // (function($) {

  // $.fn.disableSelection = function() {
  //     return this.each(function() {
  //         $(this).attr('unselectable', 'on')
  //                .css({
  //                    '-moz-user-select':'none',
  //                    '-webkit-user-select':'none',
  //                    'user-select':'none',
  //                    '-ms-user-select':'none'
  //                })
  //                .each(function() {
  //                    this.onselectstart = function() { return false; };
  //                });
  //     });
  // };

  // })(jQuery);

  // $("#info").disableSelection();

    // dragging info panel ----------------------
    var drag_overlay = false;
    var drag_rel_x, drag_rel_y;

    $("#info").mousedown(function (e) {
      drag_overlay = true;
      drag_rel_x = e.clientX - $("#info").css("left").replace("px", "");
      drag_rel_y = e.clientY - $("#info").css("top").replace("px", "");
    });

    $("body").mouseup(function (e) {
      drag_overlay = false;
    });

    $("#info").mousemove(function (e) {
      if (drag_overlay) {
        $("#info").css("left", (e.clientX - drag_rel_x) + "px");
        $("#info").css("top", (e.clientY - drag_rel_y) + "px");
      }
    });
    // ------------------------------------------

});
</script>

</html>